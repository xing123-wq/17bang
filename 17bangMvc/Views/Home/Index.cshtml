@model  ViewModel.Home.IndexModel
@{
    Layout = "~/Views/Shared/Layout/_DualColumn.cshtml";
}
@section Description
{
    <title>@ViewData["title"]</title>
}

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
        #ad-chats {
            position: fixed;
            right: 270px;
            padding-right: 200px;
        }

        #chat-container {
            height: 880px;
        }

        .top-user-message {
            background-color: #eee;
            margin-top: 0px;
            padding: 5px 20px;
            padding-top: 5px;
            padding-right: 20px;
            padding-bottom: 5px;
            padding-left: 20px;
            border-bottom-left-radius: 2px 3px;
            border-bottom-right-radius: 2px 3px;
        }

        .chats {
            margin-bottom: 10px;
            height: 780px;
            overflow-y: scroll;
            padding-right: 20px;
        }
    </style>
</head>
<div class="container">
    <div class="row">
        <div class="col-md-7" id="chat-container">
            <div zyf-chat-scroll-container="" class="chats" style="padding-top: 80px;">
                <div id="history-more" class="text-center">
                    <a zyf-chat-history-more href="">更多历史 <span class="fa fa-angle-double-up"></span></a>
                </div>
                <div zyf-chats-items-container>
                    @Html.Action("AjaxPage", "ChatRoom")
                </div>
            </div>
            @if (Model.CurrentUserId != null)
            {
                <div zyf-message-sender-logon class="input-group">
                    <span class="small" zyf-chat-reply-reminder hidden></span>
                    <input zyf-chat-send-content type="text" class="form-control" placeholder="我来说两句" aria-describedby="basic-addon2">
                    <span zyf-chat-send class="input-group-addon">发送</span>
                </div>
            }
            else
            {
                @Html.Partial("_AnonymousUser")
            }
        </div>
        <div zyf-ad-chats id="ad-chats">
            <h3>“源栈”Web开发培训班 <br> <span style="color:red"><span class="fa fa-fire"></span> 火热</span> 招生中：</h3>
            <p>线上：全程直播，<b>免费</b>收看</p>
            <p>线下：<b>灵活</b>学制，拎包入住</p>
            <p>有意向的同学，可以加QQ群：326801052</p>
            <img class="img-responsive center-block" src="~/img/qq-group.png" title="QQ学习群：326801052" />
        </div>
        <script>
            function moveRight($dom) {
                $dom.addClass('text-right');
                $dom.find('[zyf-chat-reply-btn]').addClass('invisible');
            }
            $(document).ready(function () {
                setInterval(function () {
                    $('[zyf-chat-author-id]').each(function () {
                        var userId = $.cookie('UserId');
                        var right = $('[zyf-chat-items-container]');
                        if ($(this).attr('id') == userId) {
                            moveRight(right);
                        }
                    });
                }, 100);

                var timeOut = 2000,
                    refreshHanderId = 0;
                $('[zyf-chat-send]').click(function () {
                    var content = $('[zyf-chat-send-content]').val();
                    if (content) {
                        var id = $('[zyf-chat-reply-reminder]').attr('id');
                        $.ajax({
                            method: 'POST',
                            data: { 'Content': content, 'ReplyId': id },
                            url: '/ChatRoom/index',
                            success: function (data) {
                                $('[ zyf-chats-items-container]').append(data);
                            },
                            complete: function () {
                                $('[zyf-chat-send-content]').val('');
                                $('[zyf-chat-reply-reminder]').text('');
                                clearTimeout(refreshHanderId);
                                refreshChat(timeOut);
                            }
                        })
                    } else {
                        alert('* 内容不能为空')
                        return false;
                    }
                })
                $('[zyf-chat-reply-btn]').on('click', function () {
                    var id = $(this).attr('id');
                    var contents = $(this).parent().find('[zyf-chat-item-content]').text();
                    $('[zyf-chat-reply-reminder]').removeAttr('hidden').attr('id', id).text(contents);
                    clearTimeout(refreshHanderId);
                    refreshChat(timeOut);
                })

                function refreshChat(timeOut) {
                    refreshHanderId = setTimeout(function () {
                        var id = $('[zyf-chat-item-id]').last().val();
                        $.ajax({
                            url: '/ChatRoom/AjaxPage?id=' + id,
                            method: 'GET',
                            success: function (data) {
                                $('[ zyf-chats-items-container]').append(data);
                            }
                        })
                        timeOut += 100;
                        if (timeOut <= 60000) {
                            refreshChat(timeOut);
                        } else {
                            alert("longtime you was doing nothing ,now system will break connect. if you wanna connect again ,please refresh current page");
                            clearTimeout(refreshHanderId);
                        }
                    }, timeOut);
                }

                $('[zyf-ad-chats]').css('top', 120);
                $(document).scroll(function () {
                    var top = $(document).scrollTop();
                    if (top < 300) {
                        top = 120;
                    }
                    else {
                        top = 300 - top;
                    }
                    $('[zyf-ad-chats]').css('top', top);
                })
            })

        </script>
    </div>
</div>